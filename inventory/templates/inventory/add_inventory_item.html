{% extends 'inventory/base.html' %}

{% block title %}Add Inventory Item{% endblock %}

{% block content %}
<h1>Add Inventory Item</h1>

<div class="d-flex justify-content-between" style="align-items: flex-start;">
    <!-- Form on the left -->
    <div class="form-container" style="flex: 1; padding-right: 20px;">
        <form method="post" id="inventory-form">
            {% csrf_token %}
            <div class="form-group">
                {{ form.non_field_errors }}
                {{ form.as_p }}
            </div>
            <button type="submit" class="btn btn-primary">Add Item</button>
        </form>
    </div>

    <!-- Camera on the right -->
    <div id="scanner-container" style="flex: 1; display: flex; justify-content: center; align-items: center;">
        <div style="position: relative; width: 100%; max-width: 400px; padding-top: 75%; border-radius: 5px; background-color: #000;">
            <video id="video" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 5px;"></video>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const videoElement = document.querySelector('#video');
        const form = document.getElementById('inventory-form');
        const codeReader = new ZXing.BrowserQRCodeReader();

        let formSubmitted = false;

        const handleQRCode = (result) => {
            console.log("Detected QR Code Data:", result.text);
            document.getElementById('id_barcode').value = result.text;

            if (!formSubmitted) {
                formSubmitted = true;
                form.submit();
            }
        };

        const startScanner = () => {
            codeReader.decodeFromVideoDevice(null, videoElement, (result, error) => {
                if (result) {
                    handleQRCode(result);
                }
                if (error) {
                    console.error("Scanning error:", error);
                }
            }).catch(err => {
                console.error("Error starting ZXing QR Code scanner:", err);
            });
        };

        startScanner();

        form.addEventListener('submit', function() {
            codeReader.reset(); // Stop scanning when the form is submitted
        });
    });
</script>
{% endblock %}
{% endblock %}
