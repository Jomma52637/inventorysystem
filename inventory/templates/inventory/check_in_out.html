{% extends 'inventory/base.html' %}

{% block title %}Check In/Out{% endblock %}

{% block content %}
    <h1>Check In/Out Inventory Item</h1>
    
    {% if messages %}
        <div class="alert alert-warning" role="alert">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="check-in-out-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_barcode">Barcode</label>
            <input type="text" id="id_barcode" name="barcode" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="id_technician_name">Technician</label>
            {{ form.technician_name }}
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    <div id="scanner-container"></div>

    {% block scripts %}
    <script type="module">
        import QrScanner from 'https://cdn.jsdelivr.net/npm/qr-scanner@1.2.0/qr-scanner.min.js';
        QrScanner.WORKER_PATH = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.2.0/qr-scanner-worker.min.js';

        document.addEventListener("DOMContentLoaded", function() {
            const scannerContainer = document.querySelector('#scanner-container');
            const videoElem = document.createElement('video');
            videoElem.style.width = '100%';
            videoElem.style.height = '200px';
            scannerContainer.appendChild(videoElem);

            let formSubmitted = false; // Flag to prevent multiple submissions

            const qrScanner = new QrScanner(videoElem, (result) => {
                document.getElementById('id_barcode').value = result;

                if (!formSubmitted) {
                    formSubmitted = true;
                    
                    // Check if technician field is empty
                    const technicianField = document.querySelector('[name="technician_name"]');
                    if (technicianField && technicianField.value.trim() === '') {
                        alert('Please select a technician.');
                        formSubmitted = false; // Prevent form submission
                    } else {
                        // Delay form submission by 1 second (1000 milliseconds)
                        setTimeout(() => {
                            document.getElementById('check-in-out-form').submit();
                        }, 1000);
                    }
                }
            });

            qrScanner.start().catch(err => {
                console.error("Error starting QrScanner:", err);
            });

            document.getElementById('check-in-out-form').addEventListener('submit', function() {
                qrScanner.stop().catch(err => {
                    console.error("Error stopping QrScanner:", err);
                });
            });
        });
    </script>
    {% endblock %}
{% endblock %}
